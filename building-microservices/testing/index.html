



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Notes about various topics, courses, books, etc.">
      
      
        <link rel="canonical" href="https://marcolabarile.me/notes/building-microservices/testing/">
      
      
        <meta name="author" content="Marco Labarile">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon-16x16.png">
      <meta name="generator" content="mkdocs-0.17.3, mkdocs-material-2.7.3">
    
    
      
        <title>Testing - Marco Labarile - Notes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.8d40d89b.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.6079476c.css">
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="green" data-md-color-accent="green">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#testing" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://marcolabarile.me/notes/" title="Marco Labarile - Notes" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Marco Labarile - Notes
              </span>
              <span class="md-header-nav__topic">
                Testing
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/labarilem/notes" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      labarilem/notes
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    Marco Labarile - Notes
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/labarilem/notes" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      labarilem/notes
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Bitcoin and cryptocurrency technologies
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Bitcoin and cryptocurrency technologies
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../bitcoin-and-cryptocurrency-technologies/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../bitcoin-and-cryptocurrency-technologies/crypto-hash-functions/" title="Cryptographic hash functions" class="md-nav__link">
      Cryptographic hash functions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../bitcoin-and-cryptocurrency-technologies/digital-signature/" title="Digital signature" class="md-nav__link">
      Digital signature
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../bitcoin-and-cryptocurrency-technologies/hash-pointers-and-data-structures/" title="Hash pointers" class="md-nav__link">
      Hash pointers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../bitcoin-and-cryptocurrency-technologies/centralization-vs-decentralization/" title="Centralization and decentralization" class="md-nav__link">
      Centralization and decentralization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../bitcoin-and-cryptocurrency-technologies/distributed-consensus/" title="Distributed consensus" class="md-nav__link">
      Distributed consensus
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Building microservices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Building microservices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../microservices/" title="Microservices" class="md-nav__link">
      Microservices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../evolutionary-architects/" title="Evolutionary architects" class="md-nav__link">
      Evolutionary architects
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../how-to-model-services/" title="How to model services" class="md-nav__link">
      How to model services
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../integration/" title="Integration" class="md-nav__link">
      Integration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../splitting-the-monolith/" title="Splitting the monolith" class="md-nav__link">
      Splitting the monolith
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../deployment/" title="Deployment" class="md-nav__link">
      Deployment
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Testing
      </label>
    
    <a href="./" title="Testing" class="md-nav__link md-nav__link--active">
      Testing
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#types-of-tests" title="Types of Tests" class="md-nav__link">
    Types of Tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-scope" title="Test scope" class="md-nav__link">
    Test scope
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-tests" title="Unit Tests" class="md-nav__link">
    Unit Tests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-tests" title="Service Tests" class="md-nav__link">
    Service Tests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#end-to-end-tests" title="End-to-End Tests" class="md-nav__link">
    End-to-End Tests
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ownership" title="Ownership" class="md-nav__link">
    Ownership
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#speed" title="Speed" class="md-nav__link">
    Speed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-metaversion" title="The Metaversion" class="md-nav__link">
    The Metaversion
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-journeys-not-stories" title="Test Journeys, Not Stories" class="md-nav__link">
    Test Journeys, Not Stories
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consumer-driven-tests" title="Consumer-Driven Tests" class="md-nav__link">
    Consumer-Driven Tests
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-after-production" title="Testing after production" class="md-nav__link">
    Testing after production
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#separating-deployment-from-release" title="Separating Deployment from Release" class="md-nav__link">
    Separating Deployment from Release
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bluegreen-deployment" title="Blue/Green deployment" class="md-nav__link">
    Blue/Green deployment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canary-releasing" title="Canary Releasing" class="md-nav__link">
    Canary Releasing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mtbf-vs-mttr" title="MTBF vs MTTR" class="md-nav__link">
    MTBF vs MTTR
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cross-functional-testing" title="Cross-Functional Testing" class="md-nav__link">
    Cross-Functional Testing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#performance-tests" title="Performance Tests" class="md-nav__link">
    Performance Tests
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" title="Summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../monitoring/" title="Monitoring" class="md-nav__link">
      Monitoring
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../security/" title="Security" class="md-nav__link">
      Security
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../conway/" title="Conway's Law and System Desing" class="md-nav__link">
      Conway's Law and System Desing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../microservices-at-scale/" title="Microservices at Scale" class="md-nav__link">
      Microservices at Scale
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../conclusion/" title="Bringing It All Together" class="md-nav__link">
      Bringing It All Together
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#types-of-tests" title="Types of Tests" class="md-nav__link">
    Types of Tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-scope" title="Test scope" class="md-nav__link">
    Test scope
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-tests" title="Unit Tests" class="md-nav__link">
    Unit Tests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-tests" title="Service Tests" class="md-nav__link">
    Service Tests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#end-to-end-tests" title="End-to-End Tests" class="md-nav__link">
    End-to-End Tests
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ownership" title="Ownership" class="md-nav__link">
    Ownership
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#speed" title="Speed" class="md-nav__link">
    Speed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-metaversion" title="The Metaversion" class="md-nav__link">
    The Metaversion
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-journeys-not-stories" title="Test Journeys, Not Stories" class="md-nav__link">
    Test Journeys, Not Stories
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consumer-driven-tests" title="Consumer-Driven Tests" class="md-nav__link">
    Consumer-Driven Tests
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-after-production" title="Testing after production" class="md-nav__link">
    Testing after production
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#separating-deployment-from-release" title="Separating Deployment from Release" class="md-nav__link">
    Separating Deployment from Release
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bluegreen-deployment" title="Blue/Green deployment" class="md-nav__link">
    Blue/Green deployment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canary-releasing" title="Canary Releasing" class="md-nav__link">
    Canary Releasing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mtbf-vs-mttr" title="MTBF vs MTTR" class="md-nav__link">
    MTBF vs MTTR
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cross-functional-testing" title="Cross-Functional Testing" class="md-nav__link">
    Cross-Functional Testing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#performance-tests" title="Performance Tests" class="md-nav__link">
    Performance Tests
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" title="Summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h1>
<p>Distributed systems add complexity in automated tests too.</p>
<h2 id="types-of-tests">Types of Tests<a class="headerlink" href="#types-of-tests" title="Permanent link">&para;</a></h2>
<p>Tests can be categorized by the following diagram:</p>
<p><img alt="Image" src="../images/test-types.png" /></p>
<p>In microservices, the amount of manual tests should be kept at a minimum in order to reduce test times. Also, since there are no significant difference in manual testing, we will examine how automated testing changes from monolithic systems to microservices systems.</p>
<h2 id="test-scope">Test scope<a class="headerlink" href="#test-scope" title="Permanent link">&para;</a></h2>
<p>The Test Pyramid is a model proposed by Mike Cohn to associate the ideal amount of tests to each test scope.</p>
<p><img alt="Image" src="../images/test-pyramid.png" /></p>
<p>Note that terms like <em>service</em> and <em>unit</em> in this context are ambiguous and we will refer to the <em>UI</em> layer as <em>end-to-end</em> tests.</p>
<p>As we go up the pyramid our confidence increases but we reduce the ability to pinpoint bug causes and have a slower feedback.</p>
<p>Ideally, you want test of <strong>different scopes for different purposes</strong> (e.g. you can catch an integration bug with an e2e test and then you can keep it covered with a unit test).</p>
<p>How many tests? It's better to increase the number of tests as you go down the pyramid. Doing the opposite has the potential to keep your build <em>red</em> for long times.</p>
<h3 id="unit-tests">Unit Tests<a class="headerlink" href="#unit-tests" title="Permanent link">&para;</a></h3>
<p>They typically test a single function or method call in isolation (i.e. without starting services or using external resources such as network connectivity).</p>
<p>Done right, they can be very fast. You could run a lot of them in less than a minute.</p>
<p>These are <em>technology-facing</em> tests that will help us catch the most bugs and guide us through code restructuring thanks to their fast feedback and reliability.</p>
<p>Unit tests are also easier to be implemented than other tests.</p>
<h3 id="service-tests">Service Tests<a class="headerlink" href="#service-tests" title="Permanent link">&para;</a></h3>
<p>They are designed to bypass the user interface and test services directly.</p>
<p>In monolithic systems, a group of classes that provide a certain service to users can be tested together.</p>
<p>In microservices, we need to isolate the service we want to test so that we are able to quickly find the root cause of a bug. To achieve this isolation, we need to stub out other services interacting with the one under test.
But note that while a <strong>stubbed service</strong> does not care if it's called 1 or 100 times, a <strong>mocked service</strong> can provide you with that information so you could write more solid tests. The downside is that mocked services can make your tests brittle because of the magnitude of details tested.</p>
<p>So, after our service tests pass, we are confident that the new microservice is ready to contact other microservices with no errors. But what about other microservices calling the one we want to deploy?</p>
<h3 id="end-to-end-tests">End-to-End Tests<a class="headerlink" href="#end-to-end-tests" title="Permanent link">&para;</a></h3>
<p>They are run against the whole system, so they cover a lot of code and give you a lot of confidence that the system will work in production.
On the other hand, it's harder to diagnose an issue that comes up in e2e tests.</p>
<p>These tests are tricky to deal with, suppose we add them at the end of our deploy pipeline:</p>
<p><img alt="Image" src="../images/e2e-bad-pipe.png" /></p>
<p>Then we have 2 issues:</p>
<ol>
<li>Which services version are we going to use in our tests?</li>
<li>Executing such a pipeline for each microservice is going to be really inefficient.</li>
</ol>
<p>Both of them are solved with a <em>fan in</em> model:</p>
<p><img alt="Image" src="../images/e2e-good-pipe.png" /></p>
<p>But there are other disadvantages when using e2e tests:</p>
<ul>
<li>As the scope increases, we might face more errors due to <strong>causes unrelated to the behavior we want to test</strong> (e.g. network failures).</li>
<li>When tests <em>sometimes</em> fail because of unrelated issues (these are called <strong>flaky tests</strong>), people will tend to re-run them without any effort to understand the errors. This will cause lots of scheduled builds and lead to a broken system because some issues (e.g. concurrency issues) may slip through this process as unrelated issues. Flaky tests will also cause a <a href="https://en.wikibooks.org/wiki/Professionalism/Diane_Vaughan_and_the_normalization_of_deviance">normalization of deviance</a> in the test system, so it's mandatory to remove them (or temporarily disable them to apply a fix) as soon as they're spotted.</li>
</ul>
<h4 id="ownership">Ownership<a class="headerlink" href="#ownership" title="Permanent link">&para;</a></h4>
<p>Usually the tests of a service are owned by the team developing the service. But in e2e tests there can be multiple services involved in a single test.</p>
<p>Avoid:</p>
<ul>
<li>A <strong>free for all</strong> approach, because no team would have a real ownership of any test, causing failing tests to be ignored or easily dismissed as responsibility of another team.</li>
<li>A <strong>test team</strong> whose job is solely to write e2e tests. A team like this would not know how to fix issues caught in tests and would cause the development team to become distant from the tests of their code.</li>
</ul>
<p>Instead, aim to share responsibilities between the teams involved in each single test: everyone should be able to add a new test and it must be clear who is responsible for the success of that test.</p>
<h4 id="speed">Speed<a class="headerlink" href="#speed" title="Permanent link">&para;</a></h4>
<p>When e2e tests are too slow:</p>
<ul>
<li>They are more prone to unrelated issues happening during their execution, this makes them brittle tests.</li>
<li>The feedback cycle is slowed, so it takes more time to fix a failing build. This will cause builds to pile up: we will no longer able to quickly deploy small features.</li>
</ul>
<p>Things can be sped up by running tests in parallel, but it can only help to a certain extent.</p>
<p>To speed up your e2e tests, you should aim to remove useless tests and weigh risk/rewards of implemented tests to determine if they're worth having around. But this is a really difficult task since humans are not that good at estimating risks.</p>
<h4 id="the-metaversion">The Metaversion<a class="headerlink" href="#the-metaversion" title="Permanent link">&para;</a></h4>
<p>After running e2e tests one can start thinking, <em>So, I know all these services at these versions work together, so why not deploy them all together?</em>.
This reasoning is to avoid because it usually leads to a proposal of a unified version number for the system, which in turn leads to coupling deploys. In the end, it will lead to a microservices system without the benefits of microservices.</p>
<h4 id="test-journeys-not-stories">Test Journeys, Not Stories<a class="headerlink" href="#test-journeys-not-stories" title="Permanent link">&para;</a></h4>
<p>Despite the disadvantages, e2e test can be doable with one or two services. So what if we have 20 services?</p>
<p>Avoid:</p>
<ul>
<li>Adding an e2e for each story to implement because it leads to slow feedback times and huge overlaps in test coverage.</li>
</ul>
<p>Instead, you should test on a few core journeys. Any functionality not covered in these journeys needs to be covered in tests that analyze services in isolation from each other.</p>
<h3 id="consumer-driven-tests">Consumer-Driven Tests<a class="headerlink" href="#consumer-driven-tests" title="Permanent link">&para;</a></h3>
<p>We use e2e to be sure that when a new service is deployed the system will keep working. Another way to approach this problem is by defining <em>consumer-driven contracts (CDC)</em>, which express the expectations of the consumers of a service.</p>
<p>These tests can be run in isolation and are at the <em>service</em> test scope, although they serve a different purpose from classic service tests: we are able to identify breaking changes and decide whether to introduce breaking changes in the involved consumer service too or think through it before deploying the new service.</p>
<p><img alt="Image" src="../images/cdc-pyramid.png" /></p>
<p>The major benefit is that these tests are not as expensive as e2e tests, while they give us confidence that the new service does not break the expectations of its consumers.</p>
<p>Consumer-driven tests can be implemented by the teams developing consumer services but this requires a good communication channel between the teams. If for some reason it's hard to communicate, they can be written by the team developing the new service.</p>
<h2 id="testing-after-production">Testing after production<a class="headerlink" href="#testing-after-production" title="Permanent link">&para;</a></h2>
<p>Most testing is done before the system is in production. Still, when the system is in production:</p>
<ul>
<li>Some bugs may have slipped through our tests.</li>
<li>New failure modes are discovered.</li>
<li>Our users use the system in ways we could never expect.</li>
</ul>
<p>One reaction to this is often to define more and more tests. However, at a certain point we have we will hit diminishing returns with this approach.</p>
<h3 id="separating-deployment-from-release">Separating Deployment from Release<a class="headerlink" href="#separating-deployment-from-release" title="Permanent link">&para;</a></h3>
<p>If we deploy the system in an environment prior to directing production loads against it, we are able to detect issues specific to the environment.</p>
<p>In this environment we can also run <strong>smoke tests</strong> to make sure that the deploy was successful and there are no environmental issues.</p>
<p>There are different practices that you can adopt to follow this approach.</p>
<h4 id="bluegreen-deployment">Blue/Green deployment<a class="headerlink" href="#bluegreen-deployment" title="Permanent link">&para;</a></h4>
<p>With blue/green deployment we have two copies of our software deployed at a time, but only one version of it is receiving real requests.</p>
<p>This diagram describes how blue/green deployment works:</p>
<p><img alt="Image" src="../images/blue-green-dep.png" /></p>
<p>Benefits:</p>
<ul>
<li>Smoke tests can be run after the deploy.</li>
<li>If we keep the old version running, we can quickly fallback to it if we detect errors in the new version. The <em>detect and revert</em> process can be automated too.</li>
<li>Zero downtime between deploys can be achieved.</li>
</ul>
<p>Downsides:</p>
<ul>
<li>Requires some networking engineering but usually cloud providers support the needed functionalities.</li>
</ul>
<h4 id="canary-releasing">Canary Releasing<a class="headerlink" href="#canary-releasing" title="Permanent link">&para;</a></h4>
<p>With canary releasing, we verify our newly deployed service by directing amounts of production traffic against it to see if it performs as expected.</p>
<p>Performance can be measured the way you prefer, some examples are:</p>
<ul>
<li>Measuring response times.</li>
<li>Measuring error rates.</li>
<li>Measuring sales conversions of a new recommendation algorithm.</li>
</ul>
<p>When considering canary releasing, you need to decide if you are going to divert a portion of production requests to the canary or just copy production load.</p>
<p>Benefits:</p>
<ul>
<li>Has all the benefits provided by blue/green deployment.</li>
<li>Lets you evaluate the performance of the new service according to custom/complex metrics.</li>
</ul>
<p>Downsides:</p>
<ul>
<li>More difficult to setup than blue/green deployment.</li>
<li>Needs advanced network routing capabilities.</li>
<li>May need more computing power because of multiple services that have to run together for long times.</li>
</ul>
<h4 id="mtbf-vs-mttr">MTBF vs MTTR<a class="headerlink" href="#mtbf-vs-mttr" title="Permanent link">&para;</a></h4>
<p>By using techniques such as blue/green and canary deployment we acknowledge that some issues can only be discovered in production: sometimes expending the same effort into getting better at remediation of a release can be significantly more beneficial than adding more automated tests.
This is referred to as the trade-off between optimizing for <strong>mean time between failures</strong> (<em>MTBF</em>) and <strong>mean time to repair</strong> (<em>MTTR</em>).</p>
<p>For different organizations, this trade-off between MTBF and MTTR will vary, and much of this lies with understanding the true impact of failure in a production environment.</p>
<h2 id="cross-functional-testing">Cross-Functional Testing<a class="headerlink" href="#cross-functional-testing" title="Permanent link">&para;</a></h2>
<p><em>Nonfunctional requirements</em> describe those characteristics your system exhibits that cannot simply be implemented like a normal feature. We will use the term <strong>cross-functional requirements</strong> <em>(CFR)</em> instead to refer to these tests.</p>
<p>As example, these are popular CFRs:</p>
<ul>
<li>Latency of a web server.</li>
<li>Maximum concurrent users.</li>
<li>How secure the stored data should be.</li>
</ul>
<p>Tests around CFRs should follow the pyramid too: some tests will have to be end-to-end (e.g. load tests) but others won’t (e.g. tests to catch performance bottlenecks).</p>
<p>It's really important to consider CFRs from the start of the development process, because they shape too the design of your system.</p>
<h3 id="performance-tests">Performance Tests<a class="headerlink" href="#performance-tests" title="Permanent link">&para;</a></h3>
<p>Performance tests are a way of ensuring that some of our CFRs can be met.</p>
<p>In microservices systems performance is critical since what would be a single database call in a monolithic system could now become 3-4 calls to different services.</p>
<p>As with functional tests, you may want different performance tests for each test scope.</p>
<p>Due to the time it takes to run performance tests, it isn’t always feasible to run them on every check-in. It is a common practice to run a subset every day, and a larger set every week.</p>
<p>Also, it's important to have targets so that the results of these tests can be correctly interpreted and evaluated (they may mark a build as failed is the performance level is below a certain threshold).</p>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<p>Fundamental notions:</p>
<ul>
<li>Optimize for fast feedback, and separate types of tests accordingly.</li>
<li>Avoid the need for end-to-end tests wherever possible by using consumer-driven contracts.</li>
<li>Use consumer-driven contracts to provide focus points for conversations between teams.</li>
<li>Try to understand the trade-off between putting more efforts into testing and detecting issues faster in production (optimizing for MTBF versus MTTR).</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../deployment/" title="Deployment" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Deployment
              </span>
            </div>
          </a>
        
        
          <a href="../monitoring/" title="Monitoring" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Monitoring
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/labarilem" class="md-footer-social__link fa fa-github-alt"></a>
    
      <a href="https://www.linkedin.com/in/marcolabarile/" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.b438e6c5.js"></script>
      
      <script>app.initialize({version:"0.17.3",url:{base:"../.."}})</script>
      
    
    
      
        <script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-117745201-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>
      
    
  </body>
</html>